<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel BI - Supervisão Senac 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        :root {
            --senac-blue: #004587;
            --senac-orange: #f68d2e;
            --senac-light-blue: #0056a3;
        }

        /* Classes Utilitárias Senac */
        .text-senac-blue { color: var(--senac-blue); }
        .text-senac-orange { color: var(--senac-orange); }
        .bg-senac-blue { background-color: var(--senac-blue); }
        .bg-senac-orange { background-color: var(--senac-orange); }
        
        .card-bi { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); 
            border: 1px solid #e2e8f0; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-bi:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Loader */
        .loader { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #f68d2e; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header 2025 -->
    <header class="bg-white h-20 flex items-center justify-between px-8 border-b border-slate-200 flex-shrink-0 z-30 shadow-sm">
        <div class="flex items-center gap-4">
            <!-- Logo Senac CSS -->
            <div class="flex flex-col select-none">
                <div class="flex items-baseline leading-none">
                    <span class="text-3xl font-extrabold text-senac-blue tracking-tight">Senac</span>
                </div>
                <div class="w-full h-1.5 bg-senac-orange mt-1 rounded-full"></div>
            </div>
            <div class="h-10 w-px bg-slate-200 mx-2"></div>
            <div>
                <h1 class="font-bold text-lg text-slate-700">Painel de Supervisão</h1>
                <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Gestão de Aprendizagem</p>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <!-- Botão Upload -->
            <div class="flex items-center gap-3">
                <input type="file" id="fileInput" accept=".csv, .xlsx, .xlsm, .xls" class="hidden" onchange="processFile(this)">
                <button onclick="document.getElementById('fileInput').click()" class="group flex items-center gap-2 bg-slate-50 hover:bg-senac-blue hover:text-white text-slate-600 px-4 py-2.5 rounded-xl border border-slate-200 transition-all shadow-sm">
                    <i data-lucide="upload-cloud" class="w-4 h-4 text-senac-orange group-hover:text-white transition-colors"></i>
                    <span class="text-xs font-bold uppercase">Importar Dados</span>
                </button>
                <div id="loadingSpinner" class="hidden"><div class="loader border-t-senac-blue"></div></div>
            </div>

            <div class="text-right hidden md:block border-l border-slate-200 pl-6">
                <p class="text-xs font-bold text-senac-blue">Gestão 2025</p>
                <p class="text-[10px] text-slate-400 font-mono" id="currentDate">--/--/----</p>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- Sidebar Filtros -->
        <aside class="w-80 bg-white border-r border-slate-200 flex flex-col z-20 overflow-y-auto shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-bold text-slate-700 flex items-center gap-2 mb-5">
                    <div class="p-1.5 bg-white border border-slate-200 rounded-lg shadow-sm text-senac-orange">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                    </div>
                    Filtros Avançados
                </h3>
                
                <!-- Busca -->
                <div class="relative group mb-5">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-senac-blue transition-colors"></i>
                    <input type="text" id="filterSearch" onkeyup="applyFilters()" placeholder="Buscar Jovem ou Turma..." 
                           class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:border-senac-blue focus:ring-4 focus:ring-blue-50 outline-none transition-all shadow-sm">
                </div>

                <!-- Filtro Situação do Contrato (Novo) -->
                <div class="mb-6">
                    <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Situação do Contrato</label>
                    <div class="relative">
                        <select id="filterContractStatus" onchange="applyFilters()" class="w-full appearance-none p-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50 transition-all cursor-pointer text-slate-700 font-medium">
                            <option value="active">Apenas Ativos (Padrão)</option>
                            <option value="closed" class="text-red-600 font-bold">Apenas Encerrados</option>
                            <option value="all">Todos (Ativos + Encerrados)</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1 ml-1">Use "Apenas Encerrados" para relatórios finais.</p>
                </div>

                <!-- Dropdowns -->
                <div class="space-y-4">
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Região</label>
                        <div class="relative">
                            <select id="filterRegiao" onchange="applyFilters()" class="w-full appearance-none p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:bg-white transition-all cursor-pointer text-slate-700">
                                <option value="">Todas as Regiões</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Cidade</label>
                        <div class="relative">
                            <select id="filterCidade" onchange="applyFilters()" class="w-full appearance-none p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:bg-white transition-all cursor-pointer text-slate-700">
                                <option value="">Todas as Cidades</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legenda -->
            <div class="p-6 mt-auto bg-slate-50 border-t border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Legenda de Situação</p>
                <div class="space-y-2.5">
                    <div class="flex items-center gap-2.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)]"></div>
                        <span class="text-xs text-slate-600 font-medium">No Prazo / Realizada</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.4)]"></div>
                        <span class="text-xs text-slate-600 font-medium">Atrasado (> 90 dias)</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-slate-400"></div>
                        <span class="text-xs text-slate-400">Encerrado</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="flex-1 flex flex-col overflow-hidden bg-slate-50/50 relative">
            
            <!-- Dashboard BI -->
            <div class="p-6 pb-2 grid grid-cols-12 gap-6 h-auto flex-shrink-0">
                
                <!-- KPIs -->
                <div class="col-span-12 lg:col-span-3 grid grid-cols-1 gap-4">
                    <!-- Card Total -->
                    <div onclick="filterByStatus('all')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-senac-blue">
                        <div class="flex justify-between items-start z-10 relative">
                            <div>
                                <p class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-1">Total Filtrado</p>
                                <h2 class="text-3xl font-extrabold text-slate-800 group-hover:text-senac-blue transition-colors" id="kpiTotal">0</h2>
                            </div>
                            <div class="p-2.5 bg-blue-50 text-senac-blue rounded-xl group-hover:scale-110 transition-transform">
                                <i data-lucide="users" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Card Atrasados -->
                    <div onclick="filterByStatus('atrasado')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-red-500">
                        <div class="flex justify-between items-start z-10 relative">
                            <div>
                                <p class="text-[11px] text-red-400 font-bold uppercase tracking-wider mb-1">Visitas Atrasadas</p>
                                <h2 class="text-3xl font-extrabold text-red-600" id="kpiAtrasados">0</h2>
                                <p class="text-[10px] text-red-400 mt-1 font-medium">Fora do prazo de 90 dias</p>
                            </div>
                            <div class="p-2.5 bg-red-50 text-red-500 rounded-xl group-hover:scale-110 transition-transform">
                                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card No Prazo -->
                    <div onclick="filterByStatus('noprazo')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-emerald-500">
                        <div class="flex justify-between items-start z-10 relative">
                            <div>
                                <p class="text-[11px] text-emerald-500 font-bold uppercase tracking-wider mb-1">Em Dia</p>
                                <h2 class="text-3xl font-extrabold text-emerald-600" id="kpiNoPrazo">0</h2>
                            </div>
                            <div class="p-2.5 bg-emerald-50 text-emerald-500 rounded-xl group-hover:scale-110 transition-transform">
                                <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico Rosca (Status) -->
                <div class="col-span-12 md:col-span-4 lg:col-span-4 card-bi p-5 flex flex-col">
                    <h3 class="text-xs font-bold text-slate-600 uppercase mb-4 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-4 h-4 text-senac-orange"></i> Status Geral
                    </h3>
                    <div class="flex-1 min-h-0 relative flex items-center justify-center">
                        <canvas id="chartStatus"></canvas>
                    </div>
                </div>

                <!-- Gráfico Barras (Região) -->
                <div class="col-span-12 md:col-span-5 lg:col-span-5 card-bi p-5 flex flex-col">
                    <h3 class="text-xs font-bold text-slate-600 uppercase mb-4 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-senac-blue"></i> Top Regiões
                    </h3>
                    <div class="flex-1 min-h-0 relative">
                        <canvas id="chartRegiao"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="flex-1 px-6 pb-6 overflow-hidden flex flex-col">
                <div class="card-bi flex-1 flex flex-col overflow-hidden bg-white">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-slate-100 rounded-lg text-slate-600">
                                <i data-lucide="list" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-700 text-sm">Detalhamento dos Contratos</h3>
                                <p class="text-xs text-slate-400 mt-0.5">Mostrando <strong id="countFiltered" class="text-senac-blue">0</strong> registros</p>
                            </div>
                        </div>
                        
                        <!-- BOTÃO DE EXPORTAR -->
                        <button onclick="exportFilteredReport()" class="flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-xs font-bold transition-all shadow-md shadow-emerald-200">
                            <i data-lucide="download" class="w-4 h-4"></i> Baixar Relatório Filtrado
                        </button>
                    </div>

                    <div class="flex-1 overflow-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 sticky top-0 z-10 text-[11px] uppercase text-slate-500 font-bold tracking-wide shadow-sm">
                                <tr>
                                    <th class="p-4 w-[25%]">Jovem / Turma</th>
                                    <th class="p-4 w-[20%]">Empresa / Cidade</th>
                                    <th class="p-4 w-[20%]">Supervisor</th>
                                    <th class="p-4 w-[10%] text-center">Início/Fim</th>
                                    <th class="p-4 w-[15%] text-center">Situação Visitas</th>
                                    <th class="p-4 w-[10%] text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-100 text-sm">
                                <tr>
                                    <td colspan="6" class="p-12 text-center text-slate-400">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center">
                                                <i data-lucide="file-spreadsheet" class="w-8 h-8 opacity-40"></i>
                                            </div>
                                            <p>Aguardando importação...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-3 border-t border-slate-100 flex justify-between items-center bg-slate-50 rounded-b-2xl px-6">
                        <span class="text-xs text-slate-500">Página <span id="pageDisplay" class="font-bold text-slate-700">1</span></span>
                        <div class="flex gap-2">
                            <button onclick="changePage(-1)" class="px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-white text-xs font-bold text-slate-600 disabled:opacity-50 transition-all shadow-sm" id="btnPrev">Anterior</button>
                            <button onclick="changePage(1)" class="px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-white text-xs font-bold text-slate-600 disabled:opacity-50 transition-all shadow-sm" id="btnNext">Próxima</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SCRIPT -->
    <script>
        const today = new Date();
        document.getElementById('currentDate').innerText = today.toLocaleDateString('pt-BR');

        let rawData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        
        // Gráficos
        let chartStatusInstance = null;
        let chartRegiaoInstance = null;

        window.onload = () => lucide.createIcons();

        // -----------------------------------------------------------
        // 1. Processamento de Dados
        // -----------------------------------------------------------
        function processFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            document.getElementById('loadingSpinner').classList.remove('hidden');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                setTimeout(() => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        let sheetName = workbook.SheetNames.find(n => n.toLowerCase().trim() === "dados gerais");
                        if(!sheetName) sheetName = workbook.SheetNames[0]; 

                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});
                        
                        if(json.length < 2) throw new Error("Vazio");

                        const headers = json[0].map(h => String(h).trim());
                        
                        const getIdx = (candidates) => {
                            for(let c of candidates) {
                                const i = headers.findIndex(h => h.toLowerCase().includes(c.toLowerCase()));
                                if(i > -1) return i;
                            }
                            return -1;
                        }

                        // Mapeamento
                        const map = {
                            nome: getIdx(["Apr. Nome", "Nome", "Jovem"]),
                            turma: getIdx(["Turma", "Matrícula"]),
                            hrTeoria: getIdx(["Teoria Hr Ini", "Horario Teoria"]),
                            cidade: getIdx(["Emp. Cidade"]),
                            regiao: getIdx(["Atuação Senac", "Região"]),
                            empresa: getIdx(["Razao Social", "Empresa"]),
                            supNome: getIdx(["Sup. Cadastrado", "Supervisor"]),
                            supCel: getIdx(["Sup Celular"]),
                            supEmail: getIdx(["Sup. Email"]),
                            dtIni: getIdx(["TurDatIni"]),
                            dtFim: getIdx(["TurDatFim"]),
                            v1Dt: getIdx(["Data da Visita 1"]),
                            v1St: getIdx(["Status Visita 1"]),
                            v2Dt: getIdx(["Data da Visita 2"]),
                            v2St: getIdx(["Status Visita"]), 
                            v3Dt: getIdx(["Data da Visita 3"]),
                            v3St: getIdx(["Status Visita"])
                        };

                        rawData = json.slice(1).map((row, i) => {
                            if(!row[map.nome]) return null;
                            
                            const idxV2St = map.v2Dt > -1 ? map.v2Dt + 1 : -1; 
                            const idxV3St = map.v3Dt > -1 ? map.v3Dt + 1 : -1;

                            return {
                                id: i,
                                nome: String(row[map.nome]).trim(),
                                turma: String(row[map.turma] || "N/A"),
                                hrTeoria: formatExcelTime(row[map.hrTeoria]), 
                                cidade: row[map.cidade] || "N/A",
                                regiao: row[map.regiao] || "Geral",
                                empresa: row[map.empresa],
                                supervisor: {
                                    nome: row[map.supNome] || "Não inf.",
                                    cel: row[map.supCel] || "",
                                    email: row[map.supEmail] || ""
                                },
                                inicio: parseDate(row[map.dtIni]),
                                fim: parseDate(row[map.dtFim]),
                                visits: [
                                    { date: parseDate(row[map.v1Dt]), status: String(row[map.v1St]).trim(), label: "1ª" },
                                    { date: parseDate(row[map.v2Dt]), status: String(row[idxV2St] || row[map.v2St]).trim(), label: "2ª" },
                                    { date: parseDate(row[map.v3Dt]), status: String(row[idxV3St] || row[map.v3St]).trim(), label: "3ª" }
                                ]
                            };
                        }).filter(x => x);

                        populateFilters();
                        applyFilters();
                        document.getElementById('loadingSpinner').classList.add('hidden');
                        const btnText = document.querySelector('button span');
                        if(btnText) btnText.innerText = "Dados Atualizados";

                    } catch(e) {
                        console.error(e);
                        alert("Erro ao ler arquivo. Verifique a aba 'Dados Gerais'.");
                        document.getElementById('loadingSpinner').classList.add('hidden');
                    }
                }, 100);
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Helpers de Formatação ---
        function parseDate(val) {
            if(!val) return null;
            if(val instanceof Date) return val;
            if(typeof val === 'number') {
                const date = new Date(Math.round((val - 25569)*86400*1000));
                return new Date(date.getTime() + date.getTimezoneOffset()*60000);
            }
            if(typeof val === 'string') {
                val = val.trim();
                if(val.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [y,m,d] = val.split('-'); return new Date(y, m-1, d);
                }
                if(val.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const [d,m,y] = val.split('/'); return new Date(y, m-1, d);
                }
            }
            return null;
        }

        function formatExcelTime(val) {
            if (!val) return "-";
            if (typeof val === 'number') {
                const totalSeconds = Math.round(val * 86400);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
            return val;
        }

        // -----------------------------------------------------------
        // 2. Lógica de Negócio (Regra dos 90 Dias)
        // -----------------------------------------------------------
        function analyzeJovem(jovem) {
            const isEncerrado = jovem.fim && jovem.fim < today;
            let globalStatus = "No Prazo";
            let globalColor = "green"; // green, red, gray
            
            // Se encerrado, ignora cálculos de atraso
            if (isEncerrado) {
                return { ...jovem, processedVisits: jovem.visits, globalStatus: "Encerrado", globalColor: "gray", isEncerrado };
            }

            // Descobrir última data válida de referência (Início ou Última Visita Realizada)
            let lastReferenceDate = jovem.inicio;
            let visitsDoneCount = 0;

            const processedVisits = jovem.visits.map(v => {
                let state = "pending";
                const isRealizada = v.status.toLowerCase().includes("realizada");
                
                if (isRealizada) {
                    state = "done";
                    visitsDoneCount++;
                    if (v.date) lastReferenceDate = v.date; // Atualiza referência se tiver data
                } else {
                    // Visita pendente
                    state = "pending"; 
                }
                return { ...v, state };
            });

            // Se todas realizadas
            if (visitsDoneCount === 3) {
                globalStatus = "Concluído";
                globalColor = "blue";
                return { ...jovem, processedVisits, globalStatus, globalColor, isEncerrado };
            }

            // CÁLCULO DE ATRASO
            // Se não temos data de início, não dá pra calcular
            if (!lastReferenceDate) {
                globalStatus = "Sem Data Ini";
                globalColor = "gray";
                return { ...jovem, processedVisits, globalStatus, globalColor, isEncerrado };
            }

            // Prazo é 90 dias após a referência
            const deadline = new Date(lastReferenceDate);
            deadline.setDate(deadline.getDate() + 90);

            // Comparar hoje com deadline
            // Se hoje > deadline -> Atrasado
            if (today > deadline) {
                globalStatus = "Atrasado";
                globalColor = "red";
            } else {
                globalStatus = "No Prazo";
                globalColor = "green";
            }

            return { ...jovem, processedVisits, globalStatus, globalColor, isEncerrado };
        }


        // -----------------------------------------------------------
        // 3. Filtros e Renderização
        // -----------------------------------------------------------
        function populateFilters() {
            const regioes = [...new Set(rawData.map(i => i.regiao))].sort();
            const cidades = [...new Set(rawData.map(i => i.cidade))].sort();
            
            const selReg = document.getElementById('filterRegiao');
            selReg.innerHTML = '<option value="">Todas as Regiões</option>';
            regioes.forEach(r => selReg.innerHTML += `<option value="${r}">${r}</option>`);

            const selCid = document.getElementById('filterCidade');
            selCid.innerHTML = '<option value="">Todas as Cidades</option>';
            cidades.forEach(c => selCid.innerHTML += `<option value="${c}">${c}</option>`);
        }

        let currentStatusFilter = 'all';

        function filterByStatus(status) {
            currentStatusFilter = status;
            applyFilters();
        }

        function applyFilters() {
            const search = document.getElementById('filterSearch').value.toLowerCase();
            const regiao = document.getElementById('filterRegiao').value;
            const cidade = document.getElementById('filterCidade').value;
            const contractStatus = document.getElementById('filterContractStatus').value; // active, closed, all

            filteredData = rawData.map(analyzeJovem).filter(item => {
                // Filtro Texto
                const nameMatch = item.nome && item.nome.toLowerCase().includes(search);
                const classMatch = item.turma && item.turma.toLowerCase().includes(search);
                if(search && !nameMatch && !classMatch) return false;
                
                // Filtro Dropdowns
                if(regiao && item.regiao !== regiao) return false;
                if(cidade && item.cidade !== cidade) return false;

                // Filtro Situação Contrato (Ativo, Encerrado, Todos)
                if (contractStatus === 'active') {
                    if (item.isEncerrado) return false; // Hide closed
                } else if (contractStatus === 'closed') {
                    if (!item.isEncerrado) return false; // Hide active
                }
                // if 'all', show everything

                // Filtro Status (Click nos Cards)
                if(currentStatusFilter === 'atrasado' && item.globalColor !== 'red') return false;
                if(currentStatusFilter === 'noprazo' && item.globalColor !== 'green' && item.globalColor !== 'blue') return false;

                return true;
            });

            currentPage = 1;
            updateDashboard();
            renderTable();
        }

        function updateDashboard() {
            document.getElementById('countFiltered').innerText = filteredData.length;
            
            const total = filteredData.length;
            const atrasados = filteredData.filter(i => i.globalColor === 'red').length;
            const noPrazo = filteredData.filter(i => i.globalColor === 'green' || i.globalColor === 'blue').length;

            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiAtrasados').innerText = atrasados;
            document.getElementById('kpiNoPrazo').innerText = noPrazo;

            // Chart Status
            const ctxStatus = document.getElementById('chartStatus');
            if(chartStatusInstance) chartStatusInstance.destroy();
            
            const statusCounts = { 'No Prazo': 0, 'Atrasado': 0, 'Concluído': 0, 'Encerrado': 0 };
            filteredData.forEach(i => {
                if(i.globalColor === 'green') statusCounts['No Prazo']++;
                else if(i.globalColor === 'red') statusCounts['Atrasado']++;
                else if(i.globalColor === 'blue') statusCounts['Concluído']++;
                else statusCounts['Encerrado']++;
            });

            chartStatusInstance = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#10b981', '#ef4444', '#004587', '#94a3b8'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '70%',
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true, font: {family: 'Inter'} } } } 
                }
            });

            // Chart Region (Top 5)
            const ctxRegiao = document.getElementById('chartRegiao');
            if(chartRegiaoInstance) chartRegiaoInstance.destroy();

            const regionCounts = {};
            filteredData.forEach(i => regionCounts[i.regiao] = (regionCounts[i.regiao] || 0) + 1);
            const sortedRegions = Object.entries(regionCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);

            chartRegiaoInstance = new Chart(ctxRegiao, {
                type: 'bar',
                data: {
                    labels: sortedRegions.map(x => x[0]),
                    datasets: [{
                        label: 'Jovens',
                        data: sortedRegions.map(x => x[1]),
                        backgroundColor: '#004587',
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    indexAxis: 'y', 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { grid: {display: false} }, 
                        y: { grid: {display: false} } 
                    } 
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
            if (currentPage > totalPages) currentPage = 1;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            document.getElementById('pageDisplay').innerText = `${currentPage} / ${totalPages}`;
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages;

            const formatDate = (d) => d ? d.toLocaleDateString('pt-BR') : '-';

            pageData.forEach(item => {
                // Visual das visitas (Simplificado para bolinhas de status)
                let visitsHtml = `<div class="flex gap-4 justify-center">`;
                item.processedVisits.forEach((v, idx) => {
                    let color = "bg-slate-200";
                    if(v.state === 'done') color = "bg-emerald-500 shadow-md shadow-emerald-200";
                    
                    // Mostra data embaixo se tiver
                    const dateDisplay = v.date ? `<div class="text-[9px] text-slate-500 mt-1 font-mono">${formatDate(v.date)}</div>` : `<div class="text-[9px] text-slate-300 mt-1 font-mono">-</div>`;

                    visitsHtml += `
                        <div class="flex flex-col items-center group relative cursor-help">
                            <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-white text-xs font-bold border border-white">
                                ${idx + 1}
                            </div>
                            ${dateDisplay}
                            <!-- Tooltip -->
                            <div class="absolute bottom-full mb-2 hidden group-hover:block bg-slate-800 text-white text-[10px] p-2 rounded shadow-lg z-50 whitespace-nowrap">
                                <strong>${v.label}</strong><br>
                                Data: ${formatDate(v.date)}<br>
                                Status: ${v.status}
                            </div>
                        </div>
                    `;
                });
                visitsHtml += `</div>`;

                // Badge Status
                let badgeClass = "bg-slate-100 text-slate-500";
                if(item.globalColor === 'green') badgeClass = "bg-emerald-100 text-emerald-700 border border-emerald-200";
                if(item.globalColor === 'red') badgeClass = "bg-red-100 text-red-700 border border-red-200";
                if(item.globalColor === 'blue') badgeClass = "bg-blue-100 text-blue-700 border border-blue-200";

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50";
                tr.innerHTML = `
                    <td class="p-4 align-top">
                        <div class="font-bold text-slate-700 text-sm">${item.nome}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-mono bg-blue-50 text-blue-600 border border-blue-100">${item.turma}</span>
                            <span class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${item.hrTeoria}</span>
                        </div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs font-bold text-slate-700 truncate max-w-[150px]" title="${item.empresa}">${item.empresa}</div>
                        <div class="text-[10px] text-slate-400 mt-0.5 uppercase tracking-wide">${item.cidade}</div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs text-slate-600">
                            <div class="font-medium">${item.supervisor.nome}</div>
                            ${item.supervisor.cel ? `<div class="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5"><i data-lucide="phone" class="w-2.5 h-2.5"></i> ${item.supervisor.cel}</div>` : ''}
                             ${item.supervisor.email ? `<div class="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5 truncate max-w-[150px]" title="${item.supervisor.email}"><i data-lucide="mail" class="w-2.5 h-2.5"></i> Email</div>` : ''}
                        </div>
                    </td>
                    <td class="p-4 align-top text-center text-xs font-mono text-slate-500">
                        <div class="text-emerald-600">${formatDate(item.inicio)}</div>
                        <div class="text-slate-400 border-l h-2 mx-auto my-0.5 w-px"></div>
                        <div class="${item.isEncerrado ? 'text-red-400 line-through' : ''}">${formatDate(item.fim)}</div>
                    </td>
                    <td class="p-4 align-top">
                        ${visitsHtml}
                    </td>
                    <td class="p-4 align-top text-center">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${badgeClass}">
                            ${item.globalStatus}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function changePage(d) {
            currentPage += d;
            renderTable();
        }

        // -----------------------------------------------------------
        // 4. Exportação de Relatório (NOVA FUNÇÃO)
        // -----------------------------------------------------------
        function exportFilteredReport() {
            if (filteredData.length === 0) return alert("Nenhum dado para exportar.");

            const formatDate = (d) => d ? d.toLocaleDateString('pt-BR') : '-';
            
            // Cabeçalho do Excel
            const exportData = [[
                "Nome do Jovem", "Turma", "Horário", "Empresa", "Cidade", "Região",
                "Supervisor", "Celular Sup", "Email Sup",
                "Data Início", "Data Fim",
                "Status Geral", 
                "Data V1", "Status V1",
                "Data V2", "Status V2",
                "Data V3", "Status V3"
            ]];

            // Preenchimento
            filteredData.forEach(item => {
                const v1 = item.processedVisits[0];
                const v2 = item.processedVisits[1];
                const v3 = item.processedVisits[2];

                exportData.push([
                    item.nome, item.turma, item.hrTeoria, item.empresa, item.cidade, item.regiao,
                    item.supervisor.nome, item.supervisor.cel, item.supervisor.email,
                    formatDate(item.inicio), formatDate(item.fim),
                    item.globalStatus,
                    formatDate(v1.date), v1.status,
                    formatDate(v2.date), v2.status,
                    formatDate(v3.date), v3.status
                ]);
            });

            // Gerar Arquivo
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Relatório Filtrado");
            XLSX.writeFile(wb, `Relatorio_Gestao_Senac_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.xlsx`);
        }
    </script>
</body>
</html>
