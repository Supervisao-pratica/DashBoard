<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel BI - Supervisão Senac</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS atualizado para ler XLSM -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        :root {
            --senac-blue: #004587;
            --senac-orange: #f68d2e;
        }

        /* Estilo BI */
        .card-bi { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        .bg-senac { background-color: var(--senac-blue); }
        .text-senac { color: var(--senac-blue); }
        .border-l-4-orange { border-left: 4px solid var(--senac-orange); }
        .border-l-4-blue { border-left: 4px solid var(--senac-blue); }
        
        /* Loader */
        .loader { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-senac h-16 flex items-center justify-between px-6 text-white shadow-lg flex-shrink-0 z-20">
        <div class="flex items-center gap-3">
            <!-- Ícone/Logo simples -->
            <div class="w-8 h-8 bg-white/10 rounded flex items-center justify-center font-bold text-xs">S</div>
            <div class="font-bold text-xl tracking-wide">SENAC <span class="font-light opacity-80">| Supervisão BI</span></div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-lg border border-white/20 hover:bg-white/20 transition-colors cursor-pointer" onclick="document.getElementById('fileInput').click()">
                <!-- Aceita explicitamente .xlsm -->
                <input type="file" id="fileInput" accept=".csv, .xlsx, .xlsm, .xls" class="hidden" onchange="processFile(this)">
                <button class="text-xs font-bold uppercase hover:text-orange-300 transition-colors flex items-center gap-2 cursor-pointer pointer-events-none">
                    <i data-lucide="upload" class="w-4 h-4"></i> 
                    <span>Carregar "Dados Gerais" (.xlsx / .xlsm)</span>
                </button>
                <div id="loadingSpinner" class="hidden"><div class="loader"></div></div>
            </div>
            <div class="w-px h-6 bg-white/20"></div>
            <div class="text-right">
                <p class="text-xs font-bold">Gestor</p>
                <p class="text-[10px] opacity-75" id="currentDate">--/--/----</p>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- Sidebar Filtros -->
        <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 overflow-y-auto">
            <div class="p-5 border-b border-slate-100">
                <h3 class="font-bold text-slate-700 flex items-center gap-2 mb-4">
                    <i data-lucide="filter" class="w-4 h-4 text-senac"></i> Filtros de Dados
                </h3>
                
                <!-- Busca -->
                <div class="mb-4">
                    <input type="text" id="filterSearch" onkeyup="applyFilters()" placeholder="Buscar Nome ou Turma..." class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm focus:border-blue-700 outline-none transition-shadow focus:ring-1 focus:ring-blue-700">
                </div>

                <!-- Toggle Encerrados -->
                <div class="mb-4 bg-slate-50 p-3 rounded border border-slate-200 hover:bg-slate-100 transition-colors">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="filterEncerrados" onchange="applyFilters()" class="accent-blue-700 w-4 h-4">
                        <span class="text-xs font-bold text-slate-600">Mostrar Contratos Encerrados</span>
                    </label>
                </div>

                <!-- Dropdowns -->
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Região (Atuação)</label>
                        <select id="filterRegiao" onchange="applyFilters()" class="w-full p-2 border border-slate-200 rounded text-sm outline-none focus:border-blue-700"><option value="">Todas</option></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Cidade (Empresa)</label>
                        <select id="filterCidade" onchange="applyFilters()" class="w-full p-2 border border-slate-200 rounded text-sm outline-none focus:border-blue-700"><option value="">Todas</option></select>
                    </div>
                </div>

                <!-- Intervalo de Datas -->
                <div class="mt-4 pt-4 border-t border-slate-100">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Contrato (Início - Fim)</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <input type="date" id="dateStart" onchange="applyFilters()" class="text-xs border p-1.5 rounded outline-none focus:border-blue-700 text-slate-600">
                        <input type="date" id="dateEnd" onchange="applyFilters()" class="text-xs border p-1.5 rounded outline-none focus:border-blue-700 text-slate-600">
                    </div>
                </div>
            </div>

            <!-- Legenda Rápida -->
            <div class="p-5 mt-auto bg-slate-50 text-xs text-slate-500 space-y-2 border-t border-slate-200">
                <div class="font-bold text-slate-400 uppercase text-[10px] mb-2">Legenda Visitas</div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-100 border border-green-300 rounded-full flex items-center justify-center text-[8px] text-green-700 font-bold">✓</div> Realizada</div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-red-100 border border-red-300 rounded-full flex items-center justify-center text-[8px] text-red-700 font-bold">!</div> Atrasada</div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 bg-orange-100 border border-orange-300 rounded-full flex items-center justify-center text-[8px] text-orange-700 font-bold">⚠</div> Vence em 30d</div>
                <div class="flex items-center gap-2 mt-2 pt-2 border-t border-slate-200">
                    <i data-lucide="shield-check" class="w-3 h-3 text-green-600"></i>
                    <span class="text-[10px] text-slate-400">Dados processados localmente. Seguro.</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden bg-slate-100 relative">
            
            <!-- Dashboard BI (Gráficos) -->
            <div class="p-6 pb-2 grid grid-cols-12 gap-6 h-auto flex-shrink-0">
                <!-- KPIs -->
                <div class="col-span-12 md:col-span-3 space-y-3">
                    <div class="card-bi p-4 border-l-4-blue cursor-pointer hover:bg-blue-50 transition-colors group" onclick="filterByStatus('all')">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total Jovens</p>
                                <h2 class="text-2xl font-bold text-slate-800 group-hover:text-senac-blue transition-colors" id="kpiTotal">0</h2>
                            </div>
                            <div class="p-2 bg-blue-50 rounded text-senac-blue"><i data-lucide="users" class="w-4 h-4"></i></div>
                        </div>
                    </div>
                    <div class="card-bi p-4 border-l-4 border-l-red-500 cursor-pointer hover:bg-red-50 transition-colors group" onclick="filterByStatus('atrasado')">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-[10px] text-red-400 font-bold uppercase tracking-wider">Visitas Atrasadas</p>
                                <h2 class="text-2xl font-bold text-red-600" id="kpiAtrasados">0</h2>
                            </div>
                            <div class="p-2 bg-red-50 rounded text-red-500"><i data-lucide="alert-circle" class="w-4 h-4"></i></div>
                        </div>
                    </div>
                    <div class="card-bi p-4 border-l-4-orange cursor-pointer hover:bg-orange-50 transition-colors group" onclick="filterByStatus('atencao')">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-[10px] text-orange-400 font-bold uppercase tracking-wider">Atenção (30 dias)</p>
                                <h2 class="text-2xl font-bold text-orange-500" id="kpiAtencao">0</h2>
                            </div>
                            <div class="p-2 bg-orange-50 rounded text-orange-500"><i data-lucide="clock" class="w-4 h-4"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Pizza (Status) -->
                <div class="col-span-12 md:col-span-4 card-bi p-4 flex flex-col">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-3 h-3"></i> Status Geral
                    </h3>
                    <div class="flex-1 min-h-0 relative">
                        <canvas id="chartStatus"></canvas>
                    </div>
                </div>

                <!-- Gráfico de Barras (Regionais) -->
                <div class="col-span-12 md:col-span-5 card-bi p-4 flex flex-col">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-3 h-3"></i> Jovens por Região (Top 5)
                    </h3>
                    <div class="flex-1 min-h-0 relative">
                        <canvas id="chartRegiao"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabela Detalhada -->
            <div class="flex-1 px-6 pb-6 overflow-hidden flex flex-col">
                <div class="card-bi flex-1 flex flex-col overflow-hidden">
                    <div class="px-5 py-3 border-b border-slate-100 bg-white flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <i data-lucide="list" class="w-4 h-4 text-slate-400"></i> Detalhamento
                        </h3>
                        <div class="text-xs text-slate-400 font-mono">
                            <strong id="countFiltered" class="text-slate-700">0</strong> registros encontrados
                        </div>
                    </div>

                    <div class="flex-1 overflow-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 sticky top-0 z-10 text-xs uppercase text-slate-500 font-semibold shadow-sm">
                                <tr>
                                    <th class="p-4 w-[25%] border-b border-slate-200">Jovem / Turma</th>
                                    <th class="p-4 w-[20%] border-b border-slate-200">Empresa / Supervisor</th>
                                    <th class="p-4 w-[10%] text-center border-b border-slate-200">Início/Fim</th>
                                    <th class="p-4 w-[35%] text-center border-b border-slate-200">Controle de Visitas</th>
                                    <th class="p-4 w-[10%] text-center border-b border-slate-200">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-100 text-sm bg-white">
                                <!-- Conteúdo gerado via JS -->
                                <tr>
                                    <td colspan="5" class="p-10 text-center text-slate-400">
                                        <div class="flex flex-col items-center gap-2">
                                            <i data-lucide="file-spreadsheet" class="w-8 h-8 opacity-50"></i>
                                            <p>Carregue a planilha "Dados Gerais" para visualizar.</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginação -->
                    <div class="p-2 border-t border-slate-100 flex justify-center items-center gap-4 bg-slate-50">
                        <button onclick="changePage(-1)" class="px-3 py-1 border rounded bg-white hover:bg-slate-50 text-xs font-medium text-slate-600 transition-colors disabled:opacity-50" id="btnPrev">Anterior</button>
                        <span id="pageDisplay" class="px-3 py-1 text-xs font-bold text-slate-600 bg-slate-200 rounded">1 / 1</span>
                        <button onclick="changePage(1)" class="px-3 py-1 border rounded bg-white hover:bg-slate-50 text-xs font-medium text-slate-600 transition-colors disabled:opacity-50" id="btnNext">Próxima</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script>
        const today = new Date();
        document.getElementById('currentDate').innerText = today.toLocaleDateString('pt-BR');

        let rawData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        
        // Charts Instances
        let chartStatusInstance = null;
        let chartRegiaoInstance = null;

        window.onload = () => lucide.createIcons();

        // 1. Processamento de Arquivo
        function processFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            document.getElementById('loadingSpinner').classList.remove('hidden');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                setTimeout(() => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // Busca inteligente da aba
                        let sheetName = workbook.SheetNames.find(n => n.toLowerCase().trim() === "dados gerais");
                        if(!sheetName) sheetName = workbook.SheetNames[0]; // Fallback

                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});
                        
                        if(json.length < 2) throw new Error("Vazio");

                        // Map Headers
                        const headers = json[0].map(h => String(h).trim());
                        
                        // Função auxiliar para buscar coluna
                        const getIdx = (candidates) => {
                            for(let c of candidates) {
                                const i = headers.findIndex(h => h.toLowerCase().includes(c.toLowerCase()));
                                if(i > -1) return i;
                            }
                            return -1;
                        }

                        const map = {
                            nome: getIdx(["Apr. Nome", "Nome", "Jovem"]),
                            turma: getIdx(["Turma", "Matrícula"]),
                            hrTeoria: getIdx(["Teoria Hr Ini", "Horario Teoria"]),
                            cidade: getIdx(["Emp. Cidade"]),
                            regiao: getIdx(["Atuação Senac", "Região"]),
                            empresa: getIdx(["Razao Social", "Empresa"]),
                            supNome: getIdx(["Sup. Cadastrado", "Supervisor"]),
                            supCel: getIdx(["Sup Celular"]),
                            supEmail: getIdx(["Sup. Email"]),
                            dtIni: getIdx(["TurDatIni"]),
                            dtFim: getIdx(["TurDatFim"]),
                            v1Dt: getIdx(["Data da Visita 1"]),
                            v1St: getIdx(["Status Visita 1"]),
                            v2Dt: getIdx(["Data da Visita 2"]),
                            v2St: getIdx(["Status Visita"]), 
                            v3Dt: getIdx(["Data da Visita 3"]),
                            v3St: getIdx(["Status Visita"])
                        };

                        // Processamento das linhas
                        rawData = json.slice(1).map((row, i) => {
                            if(!row[map.nome]) return null;

                            // Correção para Status das visitas 2 e 3 que podem ter nomes repetidos/parecidos
                            // Vamos pegar os índices exatos baseados na posição da data
                            const idxV2St = map.v2Dt > -1 ? map.v2Dt + 1 : -1; 
                            const idxV3St = map.v3Dt > -1 ? map.v3Dt + 1 : -1;

                            return {
                                id: i,
                                nome: row[map.nome],
                                turma: row[map.turma] || "N/A",
                                hrTeoria: row[map.hrTeoria] || "-",
                                cidade: row[map.cidade] || "N/A",
                                regiao: row[map.regiao] || "Geral",
                                empresa: row[map.empresa],
                                supervisor: {
                                    nome: row[map.supNome] || "Não inf.",
                                    cel: row[map.supCel] || "",
                                    email: row[map.supEmail] || ""
                                },
                                inicio: parseDate(row[map.dtIni]),
                                fim: parseDate(row[map.dtFim]),
                                visits: [
                                    { date: parseDate(row[map.v1Dt]), status: String(row[map.v1St]).trim(), label: "1ª Visita" },
                                    { date: parseDate(row[map.v2Dt]), status: String(row[idxV2St] || row[map.v2St]).trim(), label: "2ª Visita" },
                                    { date: parseDate(row[map.v3Dt]), status: String(row[idxV3St] || row[map.v3St]).trim(), label: "3ª Visita" }
                                ]
                            };
                        }).filter(x => x);

                        populateFilters();
                        applyFilters();
                        document.getElementById('loadingSpinner').classList.add('hidden');
                        // Feedback visual sutil em vez de alert
                        const btn = document.querySelector('button span');
                        if(btn) btn.innerText = "Arquivo Carregado!";

                    } catch(e) {
                        console.error(e);
                        alert("Erro ao ler arquivo. Certifique-se de que é um arquivo Excel (.xlsx, .xlsm) válido e contém a aba 'Dados Gerais'.");
                        document.getElementById('loadingSpinner').classList.add('hidden');
                    }
                }, 100);
            };
            reader.readAsArrayBuffer(file);
        }

        function parseDate(val) {
            if(!val) return null;
            if(val instanceof Date) return val;
            if(typeof val === 'number') {
                const date = new Date(Math.round((val - 25569)*86400*1000));
                return new Date(date.getTime() + date.getTimezoneOffset()*60000);
            }
            if(typeof val === 'string') {
                val = val.trim();
                if(val.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [y,m,d] = val.split('-'); return new Date(y, m-1, d);
                }
                if(val.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const [d,m,y] = val.split('/'); return new Date(y, m-1, d);
                }
            }
            return null;
        }

        // 2. Lógica de Negócio (O CORAÇÃO DO SISTEMA)
        function analyzeJovem(jovem) {
            // Verifica se contrato encerrou
            const isEncerrado = jovem.fim && jovem.fim < today;
            
            let globalStatus = "Regular";
            let globalColor = "green";
            let visitsDone = 0;
            let critical = false;
            let warning = false;

            const processedVisits = jovem.visits.map(v => {
                let state = "pending"; // pending, done, late, warning
                
                // Se o status na planilha for explicitamente "Realizada" ou "realizada"
                if(v.status.toLowerCase().includes("realizada")) {
                    state = "done";
                    visitsDone++;
                } else if (v.date) {
                    // Se não está realizada, verificamos a data
                    const diffDays = Math.ceil((v.date - today) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        state = "late"; // Passou da data e não realizou
                        critical = true;
                    } else if (diffDays <= 30) {
                        state = "warning"; // Vence em 30 dias
                        warning = true;
                    } else {
                        state = "future";
                    }
                } else {
                    state = "nodate"; // Sem data definida
                }
                
                return { ...v, state };
            });

            if (visitsDone === 3) {
                globalStatus = "Concluído";
                globalColor = "blue";
            } else if (critical) {
                globalStatus = "Atrasado";
                globalColor = "red";
            } else if (warning) {
                globalStatus = "Atenção";
                globalColor = "orange";
            } else if (isEncerrado) {
                globalStatus = "Encerrado";
                globalColor = "gray";
            }

            return { ...jovem, processedVisits, globalStatus, globalColor, isEncerrado };
        }

        // 3. Filtros e Renderização
        function populateFilters() {
            const regioes = [...new Set(rawData.map(i => i.regiao))].sort();
            const cidades = [...new Set(rawData.map(i => i.cidade))].sort();
            
            const selReg = document.getElementById('filterRegiao');
            selReg.innerHTML = '<option value="">Todas</option>';
            regioes.forEach(r => selReg.innerHTML += `<option value="${r}">${r}</option>`);

            const selCid = document.getElementById('filterCidade');
            selCid.innerHTML = '<option value="">Todas</option>';
            cidades.forEach(c => selCid.innerHTML += `<option value="${c}">${c}</option>`);
        }

        let currentStatusFilter = 'all';

        function filterByStatus(status) {
            currentStatusFilter = status;
            applyFilters();
        }

        function applyFilters() {
            const search = document.getElementById('filterSearch').value.toLowerCase();
            const regiao = document.getElementById('filterRegiao').value;
            const cidade = document.getElementById('filterCidade').value;
            const showEncerrados = document.getElementById('filterEncerrados').checked;
            const dStart = document.getElementById('dateStart').value ? new Date(document.getElementById('dateStart').value) : null;
            const dEnd = document.getElementById('dateEnd').value ? new Date(document.getElementById('dateEnd').value) : null;

            filteredData = rawData.map(analyzeJovem).filter(item => {
                // Filtro Texto
                if(search && !item.nome.toLowerCase().includes(search) && !item.turma.toLowerCase().includes(search)) return false;
                
                // Filtro Dropdowns
                if(regiao && item.regiao !== regiao) return false;
                if(cidade && item.cidade !== cidade) return false;

                // Filtro Datas
                if(dStart && (!item.inicio || item.inicio < dStart)) return false;
                if(dEnd && (!item.fim || item.fim > dEnd)) return false;

                // Filtro Encerrados
                if(!showEncerrados && item.isEncerrado) return false;

                // Filtro Status (Click nos Cards)
                if(currentStatusFilter === 'atrasado' && item.globalStatus !== 'Atrasado') return false;
                if(currentStatusFilter === 'atencao' && item.globalStatus !== 'Atenção') return false;

                return true;
            });

            currentPage = 1;
            updateDashboard();
            renderTable();
        }

        function updateDashboard() {
            document.getElementById('countFiltered').innerText = filteredData.length;
            
            // KPIs
            const total = filteredData.length;
            const atrasados = filteredData.filter(i => i.globalStatus === 'Atrasado').length;
            const atencao = filteredData.filter(i => i.globalStatus === 'Atenção').length;

            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiAtrasados').innerText = atrasados;
            document.getElementById('kpiAtencao').innerText = atencao;

            // Chart Status
            const ctxStatus = document.getElementById('chartStatus');
            if(chartStatusInstance) chartStatusInstance.destroy();
            
            const statusCounts = { 'Concluído': 0, 'Regular': 0, 'Atenção': 0, 'Atrasado': 0, 'Encerrado': 0 };
            filteredData.forEach(i => statusCounts[i.globalStatus] = (statusCounts[i.globalStatus] || 0) + 1);

            chartStatusInstance = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#22c55e', '#64748b', '#f97316', '#ef4444', '#94a3b8']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } } }
            });

            // Chart Region (Top 5)
            const ctxRegiao = document.getElementById('chartRegiao');
            if(chartRegiaoInstance) chartRegiaoInstance.destroy();

            const regionCounts = {};
            filteredData.forEach(i => regionCounts[i.regiao] = (regionCounts[i.regiao] || 0) + 1);
            const sortedRegions = Object.entries(regionCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);

            chartRegiaoInstance = new Chart(ctxRegiao, {
                type: 'bar',
                data: {
                    labels: sortedRegions.map(x => x[0]),
                    datasets: [{
                        label: 'Jovens',
                        data: sortedRegions.map(x => x[1]),
                        backgroundColor: '#004587'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: {display: false} } } }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
            if(currentPage > totalPages) currentPage = totalPages;
            if(currentPage < 1) currentPage = 1;

            document.getElementById('pageDisplay').innerText = `${currentPage} / ${totalPages}`;
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages;
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            const formatDate = (d) => d ? d.toLocaleDateString('pt-BR') : '-';

            pageData.forEach(item => {
                // Monta HTML das visitas
                let visitsHtml = `<div class="flex items-center justify-center gap-2">`;
                item.processedVisits.forEach(v => {
                    let colorClass = "bg-slate-200 text-slate-500";
                    let icon = "";
                    
                    if(v.state === 'done') { colorClass = "bg-green-100 text-green-700 border border-green-200"; icon = "✓"; }
                    else if(v.state === 'late') { colorClass = "bg-red-100 text-red-700 border border-red-200 font-bold"; icon = "!"; }
                    else if(v.state === 'warning') { colorClass = "bg-orange-100 text-orange-700 border border-orange-200 font-bold"; icon = "⚠"; }
                    
                    visitsHtml += `
                        <div class="flex flex-col items-center group relative">
                            <div class="text-[9px] uppercase font-bold text-slate-400 mb-0.5">${v.label}</div>
                            <div class="px-2 py-1 rounded text-xs ${colorClass} w-24 text-center cursor-help">
                                ${icon} ${formatDate(v.date)}
                            </div>
                            <!-- Tooltip Status -->
                            <div class="absolute bottom-full mb-1 hidden group-hover:block bg-slate-800 text-white text-[10px] p-1 rounded whitespace-nowrap z-50">
                                Status: ${v.status}
                            </div>
                        </div>
                    `;
                });
                visitsHtml += `</div>`;

                // Badge Global
                let statusBadge = `<span class="px-2 py-1 rounded-full text-xs font-bold text-white bg-slate-400">${item.globalStatus}</span>`;
                if(item.globalColor === 'green') statusBadge = `<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">Em dia</span>`;
                if(item.globalColor === 'blue') statusBadge = `<span class="px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 border border-blue-200">Completo</span>`;
                if(item.globalColor === 'red') statusBadge = `<span class="px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200">Atrasado</span>`;
                if(item.globalColor === 'orange') statusBadge = `<span class="px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200">Atenção</span>`;
                if(item.globalColor === 'gray') statusBadge = `<span class="px-2 py-1 rounded-full text-xs font-bold bg-slate-200 text-slate-600 border border-slate-300">Encerrado</span>`;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50";
                tr.innerHTML = `
                    <td class="p-4 align-top">
                        <div class="font-bold text-slate-700">${item.nome}</div>
                        <div class="text-xs text-slate-500 mt-0.5 flex items-center gap-1">
                            <span class="bg-blue-50 text-blue-700 px-1 rounded border border-blue-100">${item.turma}</span>
                            <span class="text-slate-300">|</span>
                            <span class="flex items-center gap-0.5" title="Horário Teoria"><i data-lucide="clock" class="w-3 h-3"></i> ${item.hrTeoria}</span>
                        </div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs font-bold text-slate-700 truncate max-w-[180px]" title="${item.empresa}">${item.empresa}</div>
                        <div class="text-xs text-slate-400 mt-1">${item.cidade}</div>
                        
                        <!-- Supervisor Info (Hover/Small) -->
                        <div class="mt-2 text-[10px] text-slate-500 bg-slate-50 p-1.5 rounded border border-slate-100">
                            <strong>Sup:</strong> ${item.supervisor.nome}<br>
                            ${item.supervisor.cel ? `<span class="flex items-center gap-1 mt-0.5"><i data-lucide="phone" class="w-2.5 h-2.5"></i> ${item.supervisor.cel}</span>` : ''}
                            ${item.supervisor.email ? `<span class="flex items-center gap-1 mt-0.5 truncate max-w-[150px]" title="${item.supervisor.email}"><i data-lucide="mail" class="w-2.5 h-2.5"></i> ${item.supervisor.email}</span>` : ''}
                        </div>
                    </td>
                    <td class="p-4 align-top text-center">
                        <div class="text-xs text-slate-600 font-mono">Início: ${formatDate(item.inicio)}</div>
                        <div class="text-xs ${item.isEncerrado ? 'text-red-500 font-bold' : 'text-slate-500'} font-mono mt-1">
                            Fim: ${formatDate(item.fim)}
                        </div>
                    </td>
                    <td class="p-4 align-top">
                        ${visitsHtml}
                    </td>
                    <td class="p-4 align-top text-center">
                        ${statusBadge}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function changePage(d) {
            currentPage += d;
            renderTable();
        }
    </script>
</body>
</html>
