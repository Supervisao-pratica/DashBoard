<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - Acompanhamento Senac</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS para ler Excel e CSV -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Cores Senac */
        .bg-senac-blue { background-color: #004587; }
        .text-senac-blue { color: #004587; }
        .bg-senac-orange { background-color: #f68d2e; }
        .text-senac-orange { color: #f68d2e; }
        
        .border-senac-blue { border-color: #004587; }
        
        /* Animações */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #f68d2e;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200 z-30 h-16 flex-shrink-0">
        <div class="h-full px-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 bg-senac-blue rounded-lg flex items-center justify-center text-white font-bold text-xs shadow-md">
                        SENAC
                    </div>
                    <div>
                        <h1 class="font-bold text-slate-800 text-lg leading-tight">Gestão de Aprendizagem</h1>
                        <p class="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Painel "Dados Gerais"</p>
                    </div>
                </div>
                
                <div class="h-8 w-px bg-slate-200 mx-2"></div>

                <div class="flex items-center gap-2">
                    <input type="file" id="fileInput" accept=".csv, .xlsx, .xls, .xlsm" class="hidden" onchange="processFile(this)">
                    <button onclick="document.getElementById('fileInput').click()" class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-full text-xs font-bold transition-all border border-slate-200 shadow-sm">
                        <i data-lucide="file-spreadsheet" class="w-3 h-3 text-green-600"></i>
                        Carregar Planilha (.xlsx/.csv)
                    </button>
                    <div id="loadingSpinner" class="hidden"><div class="loader"></div></div>
                    <span id="fileNameDisplay" class="text-xs text-slate-400 italic hidden ml-2"></span>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p class="text-xs font-bold text-senac-blue" id="userName">Gestor Local</p>
                    <p class="text-[10px] text-slate-400" id="currentDate">--/--/----</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-senac-orange text-white flex items-center justify-center font-bold text-xs shadow-sm">
                    GL
                </div>
            </div>
        </div>
    </header>

    <!-- Área Principal -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Sidebar Filtros -->
        <aside class="w-80 bg-white border-r border-slate-200 flex flex-col z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-5 border-b border-slate-100 bg-slate-50/50">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">
                        <i data-lucide="filter" class="w-4 h-4 text-senac-orange"></i>
                        Filtros
                    </h3>
                    <button onclick="clearFilters()" class="text-[10px] text-senac-blue hover:underline font-medium">Limpar Tudo</button>
                </div>

                <div class="relative mb-4">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="filterSearch" onkeyup="applyFilters()" placeholder="Buscar Jovem..." class="w-full pl-9 pr-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-senac-blue outline-none transition-shadow">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-5">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Cidade da Empresa</label>
                    <select id="filterRegion" onchange="applyFilters()" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-md text-sm text-slate-700 outline-none focus:border-senac-blue">
                        <option value="">Todas</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Status Atenção</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                            <input type="radio" name="statusFilter" value="all" checked onchange="applyFilters()" class="text-senac-blue focus:ring-senac-blue">
                            <span class="text-sm text-slate-600">Todos</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                            <input type="radio" name="statusFilter" value="alert" onchange="applyFilters()" class="text-red-500 focus:ring-red-500">
                            <span class="text-sm text-slate-600 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-red-500"></span> Atrasados
                            </span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                            <input type="radio" name="statusFilter" value="warning" onchange="applyFilters()" class="text-amber-500 focus:ring-amber-500">
                            <span class="text-sm text-slate-600 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-amber-500"></span> Atenção Próxima
                            </span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                            <input type="radio" name="statusFilter" value="ok" onchange="applyFilters()" class="text-green-500 focus:ring-green-500">
                            <span class="text-sm text-slate-600 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span> Em Dia
                            </span>
                        </label>
                    </div>
                </div>

                <div class="pt-4 border-t border-slate-100">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Fim de Contrato</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <span class="text-[10px] text-slate-400">De:</span>
                            <input type="date" id="filterContractStart" onchange="applyFilters()" class="w-full p-1.5 bg-slate-50 border border-slate-200 rounded text-xs">
                        </div>
                        <div>
                            <span class="text-[10px] text-slate-400">Até:</span>
                            <input type="date" id="filterContractEnd" onchange="applyFilters()" class="w-full p-1.5 bg-slate-50 border border-slate-200 rounded text-xs">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-slate-200 bg-slate-50 text-center">
                <p class="text-[10px] text-slate-400">Filtrados: <strong id="filterCountDisplay" class="text-slate-700">0</strong> jovens</p>
            </div>
        </aside>

        <!-- Conteúdo Central -->
        <main class="flex-1 flex flex-col overflow-hidden bg-slate-50/50 relative">
            
            <!-- KPIs -->
            <div class="p-6 grid grid-cols-1 md:grid-cols-4 gap-4 flex-shrink-0">
                <div onclick="resetFilters()" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:shadow-md hover:border-senac-blue transition-all group">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wide">Total Geral</p>
                            <h3 id="kpiTotal" class="text-2xl font-bold text-slate-800 mt-1">0</h3>
                        </div>
                        <div class="w-8 h-8 rounded-lg bg-blue-50 text-senac-blue flex items-center justify-center group-hover:bg-senac-blue group-hover:text-white transition-colors">
                            <i data-lucide="users" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>
                <div onclick="quickFilter('alert')" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:shadow-md hover:border-red-500 transition-all group">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wide">Atenção Crítica</p>
                            <h3 id="kpiCritical" class="text-2xl font-bold text-red-600 mt-1">0</h3>
                        </div>
                        <div class="w-8 h-8 rounded-lg bg-red-50 text-red-500 flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition-colors">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-[10px] text-red-400 font-medium">Atrasados</div>
                </div>
                <div onclick="quickFilter('warning')" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:shadow-md hover:border-senac-orange transition-all group">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wide">Próximas Visitas</p>
                            <h3 id="kpiWarning" class="text-2xl font-bold text-senac-orange mt-1">0</h3>
                        </div>
                        <div class="w-8 h-8 rounded-lg bg-orange-50 text-senac-orange flex items-center justify-center group-hover:bg-senac-orange group-hover:text-white transition-colors">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-[10px] text-orange-400 font-medium">Vencem em 30 dias</div>
                </div>
                <div onclick="quickFilter('ok')" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:shadow-md hover:border-green-500 transition-all group">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wide">Ciclo Completo</p>
                            <h3 id="kpiDone" class="text-2xl font-bold text-green-600 mt-1">0</h3>
                        </div>
                        <div class="w-8 h-8 rounded-lg bg-green-50 text-green-600 flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition-colors">
                            <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="flex-1 px-6 pb-6 overflow-hidden flex flex-col">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="p-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 text-sm">Listagem Detalhada (Dados Gerais)</h2>
                        <button onclick="exportToExcel()" class="px-3 py-1.5 bg-senac-blue text-white rounded-md text-xs font-bold hover:bg-blue-800 shadow-sm flex items-center gap-1">
                            <i data-lucide="download" class="w-3 h-3"></i> Exportar
                        </button>
                    </div>

                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider w-[25%]">Jovem / Turma</th>
                                    <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Empresa / Cidade</th>
                                    <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">Início</th>
                                    <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">Ciclo Visitas</th>
                                    <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">Próxima Ação</th>
                                    <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">Fim Contrato</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-100 bg-white">
                                <tr>
                                    <td colspan="6" class="p-10 text-center flex flex-col items-center justify-center text-slate-400">
                                        <i data-lucide="file-spreadsheet" class="w-12 h-12 mb-3 text-slate-200"></i>
                                        <p>Aguardando planilha "Dados Gerais".</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="p-3 border-t border-slate-200 bg-slate-50 flex justify-between items-center text-xs text-slate-500">
                        <span>Página <span id="pageCurrent" class="font-bold text-slate-700">1</span></span>
                        <div class="flex gap-2">
                            <button onclick="changePage(-1)" class="p-1.5 border rounded hover:bg-white disabled:opacity-50" id="btnPrev"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <button onclick="changePage(1)" class="p-1.5 border rounded hover:bg-white disabled:opacity-50" id="btnNext"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const today = new Date();
        document.getElementById('currentDate').innerText = today.toLocaleDateString('pt-BR');
        
        // ESTADO
        let rawData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let uniqueRegions = new Set();

        window.onload = () => { lucide.createIcons(); };

        // --- PROCESSAMENTO DE ARQUIVO ---
        function processFile(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('fileNameDisplay').innerText = file.name;
            document.getElementById('fileNameDisplay').classList.remove('hidden');
            document.getElementById('loadingSpinner').classList.remove('hidden');

            const reader = new FileReader();

            reader.onload = function(e) {
                setTimeout(() => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // 1. TENTAR ENCONTRAR A ABA "Dados Gerais"
                        let targetSheetName = workbook.SheetNames.find(name => 
                            name.trim().toLowerCase() === "dados gerais"
                        );
                        
                        // Se não achar pelo nome exato, verifica se estamos carregando um CSV (que só tem 1 aba)
                        // ou se precisamos usar a primeira aba disponível (fallback)
                        if (!targetSheetName) {
                            if (workbook.SheetNames.length === 1) {
                                targetSheetName = workbook.SheetNames[0]; // É CSV ou só tem 1 aba
                            } else {
                                targetSheetName = workbook.SheetNames[0];
                                alert(`Aba "Dados Gerais" não encontrada! Carregando a aba: "${targetSheetName}".\nRecomendado: Use o arquivo original com a aba nomeada "Dados Gerais".`);
                            }
                        }

                        const worksheet = workbook.Sheets[targetSheetName];
                        
                        // Ler cabeçalhos (Linha 1)
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                        if (jsonData.length < 2) throw new Error("Planilha vazia.");

                        const headers = jsonData[0].map(h => String(h).trim());
                        
                        // MAPEAR ÍNDICES DAS COLUNAS (Baseado na sua planilha "Dados Gerais")
                        const idx = {
                            nome: headers.indexOf("Apr. Nome"),
                            turma: headers.indexOf("Turma"),
                            cidade: headers.indexOf("Emp. Cidade"),
                            razao: headers.indexOf("Razao Social"),
                            inicio: headers.indexOf("TurDatIni"),
                            fim: headers.indexOf("TurDatFim"),
                            v1: headers.indexOf("Data da Visita 1"),
                            v2: headers.indexOf("Data da Visita 2"),
                            v3: headers.indexOf("Data da Visita 3")
                        };

                        // Se não achou "Apr. Nome", tenta "Nome" genérico
                        if (idx.nome === -1) idx.nome = headers.findIndex(h => h.includes("Nome"));

                        console.log("Mapeamento de Colunas:", idx); // Debug no console

                        const rows = jsonData.slice(1);

                        rawData = rows.map((cols, index) => {
                            // Ignora linhas totalmente vazias
                            if (!cols || cols.every(c => c === "")) return null;
                            
                            // Extrai valores usando o mapa
                            const nomeVal = idx.nome > -1 ? cols[idx.nome] : "";
                            if (!nomeVal) return null; // Sem nome, ignora

                            const item = {
                                id: index,
                                nome: String(nomeVal).trim(),
                                turma: idx.turma > -1 ? String(cols[idx.turma]).trim() : "",
                                cidade: idx.cidade > -1 ? String(cols[idx.cidade]).trim() : "",
                                empresa: idx.razao > -1 ? String(cols[idx.razao]).trim() : "",
                                inicio: parseDateSmart(cols[idx.inicio]),
                                fim: parseDateSmart(cols[idx.fim]),
                                v1: parseDateSmart(cols[idx.v1]),
                                v2: parseDateSmart(cols[idx.v2]),
                                v3: parseDateSmart(cols[idx.v3])
                            };

                            if (item.cidade) uniqueRegions.add(item.cidade);
                            return item;

                        }).filter(i => i !== null);

                        populateRegionFilter();
                        applyFilters(); 
                        
                        document.getElementById('loadingSpinner').classList.add('hidden');
                        lucide.createIcons();
                        alert(`Sucesso! ${rawData.length} registros carregados da aba "${targetSheetName}".`);

                    } catch (err) {
                        console.error(err);
                        alert("Erro ao processar. Verifique se o arquivo tem a estrutura correta (Aba 'Dados Gerais').");
                        document.getElementById('loadingSpinner').classList.add('hidden');
                    }
                }, 100);
            };
            
            reader.readAsArrayBuffer(file);
        }

        // --- PARSER DE DATAS INTELIGENTE (ISO, BR, Excel Serial) ---
        function parseDateSmart(value) {
            if (!value) return null;

            // Se for número (Excel Serial Date)
            if (typeof value === 'number') {
                const date = new Date(Math.round((value - 25569) * 86400 * 1000));
                // Ajuste Fuso
                const offset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() + offset);
            }

            // Se for string
            if (typeof value === 'string') {
                value = value.trim();
                // Formato ISO: 2025-02-17
                if (value.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [y, m, d] = value.split('-');
                    return new Date(y, m-1, d);
                }
                // Formato BR: 17/02/2025
                if (value.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const [d, m, y] = value.split('/');
                    return new Date(y, m-1, d);
                }
            }
            return null;
        }

        function formatDate(dateObj) {
            if (!dateObj || isNaN(dateObj.getTime())) return "-";
            return dateObj.toLocaleDateString('pt-BR');
        }

        // --- LÓGICA DE NEGÓCIO ---
        function calculateStatus(item) {
            if (!item.inicio) return { status: 'unknown', text: 'Sem data', color: 'slate' };

            const nextDueDate = new Date(item.inicio);
            let phase = "";
            
            if (!item.v1) {
                nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                phase = "1ª Visita";
            } else if (!item.v2) {
                nextDueDate.setMonth(nextDueDate.getMonth() + 6);
                phase = "2ª Visita";
            } else if (!item.v3) {
                nextDueDate.setMonth(nextDueDate.getMonth() + 9);
                phase = "3ª Visita";
            } else {
                return { status: 'ok', text: 'Concluído', color: 'green', date: null };
            }

            const diffTime = nextDueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return { status: 'alert', text: `Atrasado ${Math.abs(diffDays)}d (${phase})`, color: 'red', date: nextDueDate };
            } else if (diffDays <= 30) {
                return { status: 'warning', text: `Vence em ${diffDays}d (${phase})`, color: 'orange', date: nextDueDate };
            } else {
                return { status: 'ok', text: `Em ${diffDays}d (${phase})`, color: 'slate', date: nextDueDate };
            }
        }

        function checkContractExpiry(dateObj) {
            if (!dateObj) return 'ok';
            const diffTime = dateObj - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'expired';
            if (diffDays < 30) return 'warning';
            return 'ok';
        }

        // --- FILTROS & UI ---
        function populateRegionFilter() {
            const select = document.getElementById('filterRegion');
            select.innerHTML = '<option value="">Todas</option>';
            Array.from(uniqueRegions).sort().forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.innerText = city;
                select.appendChild(opt);
            });
        }

        function resetFilters() {
            document.getElementById('filterSearch').value = '';
            document.getElementById('filterRegion').value = '';
            document.querySelector('input[name="statusFilter"][value="all"]').checked = true;
            document.getElementById('filterContractStart').value = '';
            document.getElementById('filterContractEnd').value = '';
            applyFilters();
        }

        function quickFilter(type) {
            document.querySelector(`input[name="statusFilter"][value="${type}"]`).checked = true;
            applyFilters();
        }

        function applyFilters() {
            const search = document.getElementById('filterSearch').value.toLowerCase();
            const region = document.getElementById('filterRegion').value;
            const statusType = document.querySelector('input[name="statusFilter"]:checked').value;
            const cStart = document.getElementById('filterContractStart').value ? new Date(document.getElementById('filterContractStart').value) : null;
            const cEnd = document.getElementById('filterContractEnd').value ? new Date(document.getElementById('filterContractEnd').value) : null;

            filteredData = rawData.filter(item => {
                const calc = calculateStatus(item);
                const contractStatus = checkContractExpiry(item.fim);

                if (search && !item.nome.toLowerCase().includes(search)) return false;
                if (region && item.cidade !== region) return false;

                if (statusType === 'alert') {
                    if (calc.status !== 'alert' && contractStatus !== 'expired' && contractStatus !== 'warning') return false;
                } else if (statusType === 'warning') {
                    if (calc.status !== 'warning') return false;
                } else if (statusType === 'ok') {
                    if (calc.status === 'alert' || calc.status === 'warning') return false;
                }

                if (cStart && (!item.fim || item.fim < cStart)) return false;
                if (cEnd && (!item.fim || item.fim > cEnd)) return false;

                return true;
            });

            currentPage = 1;
            updateKPIs();
            renderTable();
            document.getElementById('filterCountDisplay').innerText = filteredData.length;
        }

        function updateKPIs() {
            const data = filteredData;
            document.getElementById('kpiTotal').innerText = data.length;
            let critical = 0, warning = 0, done = 0;

            data.forEach(item => {
                const s = calculateStatus(item);
                const c = checkContractExpiry(item.fim);
                if (s.status === 'alert' || c === 'expired' || c === 'warning') critical++;
                if (s.status === 'warning') warning++;
                if (s.status === 'ok' && s.text === 'Concluído') done++;
            });

            document.getElementById('kpiCritical').innerText = critical;
            document.getElementById('kpiWarning').innerText = warning;
            document.getElementById('kpiDone').innerText = done;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400 italic">Nenhum registro encontrado.</td></tr>`;
                document.getElementById('pageCurrent').innerText = 0;
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = Math.min(start + itemsPerPage, filteredData.length);
            const pageItems = filteredData.slice(start, end);

            document.getElementById('pageCurrent').innerText = `${currentPage} (${Math.ceil(filteredData.length/itemsPerPage)})`;
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = end >= filteredData.length;

            pageItems.forEach(item => {
                const s = calculateStatus(item);
                const contractExp = checkContractExpiry(item.fim);
                const rowClass = (s.status === 'alert' || contractExp === 'expired') ? 'bg-red-50/50' : 'hover:bg-slate-50';

                const badge = (date) => date 
                    ? `<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span> <span class="text-[10px] text-green-700">${formatDate(date)}</span>`
                    : `<span class="inline-block w-2 h-2 rounded-full bg-slate-200"></span>`;

                let statusBadge = '';
                if (s.status === 'alert') statusBadge = `<div class="text-red-600 font-bold text-xs bg-red-100 px-2 py-1 rounded inline-flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> ${s.text}</div>`;
                else if (s.status === 'warning') statusBadge = `<div class="text-amber-600 font-bold text-xs bg-amber-100 px-2 py-1 rounded inline-flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${s.text}</div>`;
                else if (s.text === 'Concluído') statusBadge = `<div class="text-green-600 font-bold text-xs bg-green-100 px-2 py-1 rounded inline-flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> Completo</div>`;
                else statusBadge = `<span class="text-slate-500 text-xs">${s.text}</span>`;
                
                let contractClass = "text-slate-600";
                if (contractExp === 'expired') contractClass = "text-red-600 font-bold";
                if (contractExp === 'warning') contractClass = "text-amber-600 font-bold";

                const tr = document.createElement('tr');
                tr.className = `${rowClass} border-b border-slate-100 transition-colors fade-in`;
                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-bold text-slate-800 text-sm truncate max-w-[200px]" title="${item.nome}">${item.nome}</div>
                        <div class="text-xs text-slate-400 font-mono mt-0.5">Turma: ${item.turma}</div>
                    </td>
                    <td class="p-4">
                        <div class="text-xs font-bold text-slate-700 truncate max-w-[150px]" title="${item.empresa}">${item.empresa}</div>
                        <span class="px-2 py-0.5 bg-slate-100 text-slate-600 rounded text-[10px] font-medium mt-1 inline-block">${item.cidade || 'N/A'}</span>
                    </td>
                    <td class="p-4 text-center text-xs text-slate-600 font-mono">${formatDate(item.inicio)}</td>
                    <td class="p-4">
                        <div class="flex items-center justify-center gap-2">
                            <div class="flex flex-col items-center" title="1ª Visita">${badge(item.v1)}</div>
                            <div class="w-4 h-px bg-slate-200"></div>
                            <div class="flex flex-col items-center" title="2ª Visita">${badge(item.v2)}</div>
                            <div class="w-4 h-px bg-slate-200"></div>
                            <div class="flex flex-col items-center" title="3ª Visita">${badge(item.v3)}</div>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        ${statusBadge}
                        ${s.date ? `<div class="text-[10px] text-slate-400 mt-1">Prev: ${formatDate(s.date)}</div>` : ''}
                    </td>
                    <td class="p-4 text-center text-xs ${contractClass} font-mono">
                        ${formatDate(item.fim)}
                        ${contractExp === 'expired' ? '<br><span class="text-[9px] uppercase bg-red-100 text-red-600 px-1 rounded">Vencido</span>' : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function changePage(delta) {
            currentPage += delta;
            renderTable();
        }

        function clearFilters() { resetFilters(); }

        function exportToExcel() {
            if (filteredData.length === 0) return alert("Sem dados.");
            const exportData = [["Nome", "Turma", "Empresa", "Cidade", "Inicio", "Visita1", "Visita2", "Visita3", "Fim", "Status"]];
            filteredData.forEach(r => {
                exportData.push([r.nome, r.turma, r.empresa, r.cidade, formatDate(r.inicio), formatDate(r.v1), formatDate(r.v2), formatDate(r.v3), formatDate(r.fim), calculateStatus(r).text]);
            });
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Filtrados");
            XLSX.writeFile(wb, "Exportacao_Gestao_Senac.xlsx");
        }
    </script>
</body>
</html>
